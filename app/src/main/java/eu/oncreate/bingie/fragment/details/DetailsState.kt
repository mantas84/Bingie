package eu.oncreate.bingie.fragment.details

import com.airbnb.mvrx.MvRxState
import com.airbnb.mvrx.PersistState
import eu.oncreate.bingie.api.model.SeasonsItem
import eu.oncreate.bingie.fragment.list.ShowWithImages
import kotlin.math.min

data class DetailsState(
    @PersistState val item: ShowWithImages,
    val seasons: List<SeasonsItem> = emptyList(),
    val startSeason: Int = 1,
    val endSeason: Int = 1,
    val startEpisode: Int = 1,
    val endEpisode: Int = 1
) : MvRxState {
    constructor(initState: InitialDetailsState) : this(item = initState.item)

    val enableSliders: Boolean =
        seasons.count() != 0 && item.searchResultItem.show.airedEpisodes != 0

    val seasonsStartMin = 1
    val seasonsStartMax = min(endSeason, seasons.count().coerceAtLeast(1))

    val seasonsEndMin = min(startSeason, seasons.count().coerceAtLeast(1))
    val seasonsEndMax = seasons.count().coerceAtLeast(1)

    val episodeStartMin = 1
    val episodeStartMax = when (startSeason) {
        endSeason -> {
            min(seasons.getOrNull(startSeason - 1)?.episodeCount ?: 1, endEpisode).coerceAtLeast(1)
        }
        else -> (seasons.getOrNull(startSeason - 1)?.episodeCount ?: 1).coerceAtLeast(1)
    }

    val episodeEndMin = when (startSeason) {
        endSeason -> startEpisode
        else -> 1
    }

    val episodeEndMax = (seasons.getOrNull(endSeason - 1)?.episodeCount ?: 1).coerceAtLeast(1)

    val startEp = seasons
        .filter { it.number < startSeason }
        .fold(0, { acc, seasonsItem -> acc + seasonsItem.airedEpisodes }) +
            min(seasons.getOrNull(startSeason - 1)?.airedEpisodes ?: 0, startEpisode)

    val endEp = seasons
        .filter { it.number < endSeason }
        .fold(0, { acc, seasonsItem -> acc + seasonsItem.airedEpisodes }) +
            min(seasons.getOrNull(endSeason - 1)?.airedEpisodes ?: 0, endEpisode)

    val bingieTime = (endEp - startEp + 1) * item.searchResultItem.show.runtime

    val s = "[{\"number\":0,\"ids\":{\"trakt\":107,\"tvdb\":26788,\"tmdb\":59533,\"tvrage\":null},\"rating\":0.0,\"votes\":0,\"episode_count\":29,\"aired_episodes\":29,\"title\":\"Specials\",\"overview\":null,\"first_aired\":\"2009-10-25T04:00:00.000Z\",\"network\":\"Showtime\"},{\"number\":1,\"ids\":{\"trakt\":108,\"tvdb\":16279,\"tmdb\":59499,\"tvrage\":null},\"rating\":0.0,\"votes\":0,\"episode_count\":12,\"aired_episodes\":12,\"title\":\"Season 1\",\"overview\":\"The first season of Dexter is an adaptation of Jeff Lindsay's first novel in the Dexter series, Darkly Dreaming Dexter. Subsequent seasons have featured original storylines. This season aired from October 1, 2006 to December 17, 2006, and follows Dexter's investigation of \\\"The Ice Truck Killer\\\". Introduced in the first episode, \\\"Dexter\\\", this serial killer targets prostitutes and leaves their bodies severed and bloodless. At the same time, Dexter's foster sister, Debra Morgan, a vice squad officer, aspires to work in the homicide department, and Dexter's girlfriend, Rita Bennett, wants their relationship to be more intimate. Christian Camargo appears as Rudy Cooper and is a recurring character until the end of the season.\\n\\nThe show's first season received generally favorable reviews from critics; it was praised as \\\"bold, different and exciting, with a central character and performance that take your breath away\\\" by the New York Daily News. The Wall Street Journal saw \\\"the grotesqueries of Dexter\\\" as \\\"not something that can easily be dismissed with the old \\\"you don't have to watch\\\" line\\\", and concluded that \\\"We do have to live among the viewers who will be desensitized, or aroused, by this show\\\". The aggregate site Metacritic scored the show's first season at 77 out of 100 based on 27 critics reviews.\",\"first_aired\":\"2006-10-01T04:00:00.000Z\",\"network\":\"Showtime\"},{\"number\":2,\"ids\":{\"trakt\":109,\"tvdb\":17604,\"tmdb\":59500,\"tvrage\":null},\"rating\":0.0,\"votes\":0,\"episode_count\":12,\"aired_episodes\":12,\"title\":\"Season 2\",\"overview\":\"The second season of Dexter premiered on September 30, 2007, and ended on December 16, 2007. \\\"It's Alive\\\", the season premiere, attracted 1.09 million viewers in the United States, making Dexter the first Showtime series to attract more than a million viewers with a season premiere. The season finale, \\\"The British Invasion\\\", attracted 1.4 million viewers, making it the program's most-watched episode until the airing of the season three finale, \\\"Do You Take Dexter Morgan?\\\". Including digital video recorder usage, season two was watched by an average of 2.4 million viewers on a weekly basis through 11 full weeks, outperforming season one by 21%. The season received universal acclaim from critics, and was praised as \\\"one of the best shows on TV this decade\\\" by the Chicago Sun-Times, while Variety considers Hall's portrayal of the title character as a \\\"towering achievement, one that eclipses the show's other shortcomings and rough patches\\\"; the aggregate site Metacritic scored the season at 85 out of 100 based on 11 reviews.\\n\\nIn the season, the bodies of Dexter's victims are uncovered and an investigation is launched in Dexter's own department to find the killer, dubbed the \\\"Bay Harbor Butcher\\\". During this time, Debra struggles to recover after surviving Ice Truck Killer's attempts to murder her, and Rita sends Dexter to Narcotics Anonymous meetings when she suspects that he has an addiction. Sergeant James Doakes, stalks Dexter, suspecting that he is connected with the \\\"Ice Truck Killer\\\" killings. Three new characters are introduced: Keith Carradine appears as Special Agent Frank Lundy, an FBI agent who heads the \\\"Bay Harbor Butcher\\\" investigation, JoBeth Williams as Rita's mother Gail, and Jaime Murray as Lila Tournay, Dexter's Narcotics Anonymous sponsor.\",\"first_aired\":\"2007-09-30T04:00:00.000Z\",\"network\":\"Showtime\"},{\"number\":3,\"ids\":{\"trakt\":110,\"tvdb\":34879,\"tmdb\":59502,\"tvrage\":null},\"rating\":0.0,\"votes\":0,\"episode_count\":12,\"aired_episodes\":12,\"title\":\"Season 3\",\"overview\":\"The third season of Dexter premiered on September 28, 2008, and ended on December 14, 2008. \\\"Our Father\\\", the season premiere, attracted 1.22 million viewers in the United States, making it Showtime's highest-rated drama season premiere since Nielsen Media Research began compiling ratings in 2004. The season's finale, \\\"Do You Take Dexter Morgan?\\\" attracted 1.5 million viewers. Season three was watched by an average of 1.1 million viewers a week. It received largely positive reviews from critics, which ranged from being praised as \\\"truly and incredibly exciting television\\\" in the San Francisco Chronicle, to \\\"lack[ing] the crackling tension the drama had supplied in previous years\\\" by the Chicago Tribune; the aggregate site Metacritic scored the season at 78 out of 100 based on 13 reviews. Smits and Hall received Emmy nominations for their roles as Miguel Prado and Dexter Morgan respectively, while the show as a whole also received a Best Drama Emmy nomination.\\n\\nIn this season, Dexter kills a man in self-defense and initiates a friendship with the man's brother, Assistant District Attorney Miguel Prado. In the meantime, Rita discovers that she is pregnant, and Debra investigates the murders of a new serial killer, called \\\"The Skinner\\\", hoping to gain a promotion to detective. In addition to Smits, Dexter's third season introduces two recurring characters: Desmond Harrington as Det. Joey Quinn, who becomes Debra's partner when he is transferred from the narcotics department to homicide, and Anne Ramsay as Ellen Wolf, a defense attorney whom Miguel detests.\",\"first_aired\":\"2008-09-28T04:00:00.000Z\",\"network\":\"Showtime\"},{\"number\":4,\"ids\":{\"trakt\":111,\"tvdb\":41602,\"tmdb\":59504,\"tvrage\":null},\"rating\":0.0,\"votes\":0,\"episode_count\":12,\"aired_episodes\":12,\"title\":\"Season 4\",\"overview\":\"On October 21, 2008, Showtime commissioned a fourth and fifth season of Dexter, each consisting of 12 episodes. The show's writers convened during February and March 2009 to brainstorm ideas for the fourth season, and filming was scheduled to begin in June 2009. On May 27, 2009, Showtime announced that John Lithgow would guest star in all 12 episodes as Miami's latest and deadliest serial killer, and Keith Carradine would return as Lundy. The fourth season premiered on September 27, 2009, and focused on Dexter attempting to find his way to balance his family life, the birth of his son, and his \\\"extra-curricular\\\" activities. The season received positive reviews before airing, including one from Michael Ausiello of Entertainment Weekly, who saw the fourth season as being \\\"bloody promising\\\". The season opener was leaked to the Internet ahead of schedule in late August 2009. The fourth season premiered in the UK on the FX channel on August 20, 2010.\",\"first_aired\":\"2009-09-27T04:00:00.000Z\",\"network\":\"Showtime\"},{\"number\":5,\"ids\":{\"trakt\":112,\"tvdb\":268911,\"tmdb\":59506,\"tvrage\":null},\"rating\":0.0,\"votes\":0,\"episode_count\":12,\"aired_episodes\":12,\"title\":\"Season 5\",\"overview\":\"The fifth season of Dexter premiered on September 26, 2010, and consisted of 12 episodes. The season focuses on how Dexter comes to terms with the aftermath of the Season 4 finale, stopping a group of serial rapists and avoiding a corrupt cop who learns his deadly secret.\",\"first_aired\":\"2010-09-26T04:00:00.000Z\",\"network\":\"Showtime\"},{\"number\":6,\"ids\":{\"trakt\":113,\"tvdb\":454101,\"tmdb\":59509,\"tvrage\":null},\"rating\":9.0,\"votes\":1,\"episode_count\":12,\"aired_episodes\":12,\"title\":\"Season 6\",\"overview\":\"The sixth season of Dexter premiered on October 2, 2011 on the television cable network Showtime, and consisted of 12 episodes. The season follows Dexter's and Miami Metro's investigations into a string of bizarre ritualistic killings featuring overtly religious apocalyptic symbolism. On November 18, 2011, it was announced that Dexter had been renewed for two more seasons.\",\"first_aired\":\"2011-10-02T04:00:00.000Z\",\"network\":\"Showtime\"},{\"number\":7,\"ids\":{\"trakt\":114,\"tvdb\":483597,\"tmdb\":59510,\"tvrage\":null},\"rating\":0.0,\"votes\":0,\"episode_count\":12,\"aired_episodes\":12,\"title\":\"Season 7\",\"overview\":\"The seventh season of Dexter premiered on September 30, 2012. The season follows Dexter's tangles with a Ukrainian mob boss and introduces the character Hannah McKay, a mysterious widow with a green thumb and a checkered past. The season seven story arc is continued over the course of the eighth season, which premiered on June 30, 2013.\",\"first_aired\":\"2012-09-30T04:00:00.000Z\",\"network\":\"Showtime\"},{\"number\":8,\"ids\":{\"trakt\":115,\"tvdb\":509766,\"tmdb\":59512,\"tvrage\":null},\"rating\":0.0,\"votes\":0,\"episode_count\":12,\"aired_episodes\":12,\"title\":\"Season 8\",\"overview\":\"The eighth and final season of Dexter premiered on June 30, 2013. The season follows Dexter, who is forced to deal with his past when he comes across Dr. Evelyn Vogel, a woman who claims to have structured the code for him alongside Harry. This season also deals with a new serial killer in Miami that removes pieces of the victims' brains, and with Debra who is trying to deal with what she has done.\",\"first_aired\":\"2013-06-30T04:00:00.000Z\",\"network\":\"Showtime\"}]"
}
